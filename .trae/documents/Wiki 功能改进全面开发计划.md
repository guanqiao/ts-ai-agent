# Wiki 功能改进全面开发计划

## 📋 项目概述

基于对 `ts-ai-agent` 项目现有 Wiki 功能的分析，制定以下改进计划。当前已实现核心功能（页面管理、AI 知识库、Git 集成、自动生成文档），本计划聚焦于**版本控制、搜索增强、Web 界面、协作功能**等关键改进点。

---

## 🎯 目标

对标企业级 Wiki 系统（如 Confluence、Outline），将当前 Wiki 从"文档生成工具"升级为"智能化知识管理平台"。

---

## 📅 开发阶段规划

### Phase 1: 版本控制与历史记录系统（数据安全基础）
**优先级：🔴 高 | 预估时间：6-8 小时**

#### 1.1 页面历史版本存储
- **任务**：实现完整的页面历史版本管理
- **文件**：`src/wiki/wiki-history.ts` (新增)
- **功能**：
  - 存储每个页面的所有历史版本
  - 支持版本元数据（修改人、修改时间、修改摘要）
  - 版本差异存储（增量存储优化空间）

#### 1.2 版本对比（Diff）功能
- **任务**：实现页面版本对比
- **文件**：`src/wiki/wiki-diff.ts` (新增)
- **功能**：
  - 文本差异算法实现（基于 Myers 算法）
  - Markdown 感知差异（保留格式）
  - 可视化 Diff 输出

#### 1.3 版本回滚
- **任务**：支持恢复到指定版本
- **文件**：`src/wiki/wiki-manager.ts` (修改)
- **功能**：
  - `rollback(pageId, version)` 方法
  - 回滚前创建备份点
  - 回滚后重新构建索引

#### 1.4 变更记录审计
- **任务**：记录所有变更操作
- **文件**：`src/wiki/types.ts` (扩展类型)
- **功能**：
  - 审计日志类型定义
  - 记录创建、修改、删除、回滚操作
  - 支持按时间范围查询

#### 1.5 测试覆盖
- **文件**：`tests/wiki/wiki-history.test.ts` (新增)
- **测试用例**：
  - 历史版本保存和加载
  - 版本对比准确性
  - 回滚功能正确性
  - 审计日志完整性

---

### Phase 2: 搜索功能增强（核心体验）
**优先级：🔴 高 | 预估时间：8-10 小时**

#### 2.1 全文搜索引擎集成
- **任务**：集成 FlexSearch 搜索引擎
- **依赖**：`flexsearch: ^0.7.31`
- **文件**：`src/wiki/wiki-search-engine.ts` (新增)
- **功能**：
  - 高性能全文索引
  - 支持中文分词
  - 索引持久化到磁盘

#### 2.2 模糊搜索与拼写纠错
- **任务**：实现模糊匹配和纠错
- **文件**：`src/wiki/wiki-search-engine.ts` (扩展)
- **功能**：
  - 编辑距离算法（Levenshtein）
  - 相似词推荐
  - 拼音搜索支持

#### 2.3 高级搜索筛选
- **任务**：支持多维度筛选
- **文件**：`src/wiki/wiki-storage.ts` (修改)
- **功能**：
  - 按分类筛选
  - 按标签筛选
  - 按日期范围筛选
  - 按作者筛选
  - 组合条件搜索

#### 2.4 搜索建议与自动补全
- **任务**：实现搜索建议
- **文件**：`src/wiki/wiki-search-engine.ts` (扩展)
- **功能**：
  - 输入时实时建议
  - 热门搜索推荐
  - 搜索历史记录

#### 2.5 语义搜索增强
- **任务**：基于向量的语义搜索
- **文件**：`src/wiki/wiki-knowledge-base.ts` (修改)
- **功能**：
  - 页面内容向量化
  - 向量相似度计算
  - 混合搜索（关键词 + 语义）

#### 2.6 测试覆盖
- **文件**：`tests/wiki/wiki-search.test.ts` (新增)
- **测试用例**：
  - 全文搜索准确性
  - 模糊搜索容错性
  - 高级筛选功能
  - 搜索建议质量

---

### Phase 3: Web 界面开发（用户体验）
**优先级：🔴 高 | 预估时间：15-20 小时**

#### 3.1 Web 服务器搭建
- **任务**：创建轻量级 Web 服务器
- **依赖**：`express: ^4.18.2`, `cors: ^2.8.5`
- **文件**：`src/web/server.ts` (新增)
- **功能**：
  - Express 服务器
  - RESTful API 设计
  - 静态资源服务

#### 3.2 API 接口层
- **任务**：实现 Wiki REST API
- **文件**：`src/web/routes/wiki.ts` (新增)
- **接口列表**：
  - `GET /api/wiki/pages` - 获取页面列表
  - `GET /api/wiki/pages/:id` - 获取页面详情
  - `POST /api/wiki/pages` - 创建页面
  - `PUT /api/wiki/pages/:id` - 更新页面
  - `DELETE /api/wiki/pages/:id` - 删除页面
  - `GET /api/wiki/search?q=keyword` - 搜索
  - `GET /api/wiki/categories` - 获取分类
  - `GET /api/wiki/tags` - 获取标签

#### 3.3 前端界面框架
- **任务**：创建前端界面
- **依赖**：`vite: ^5.0.0` (开发), `react: ^18.2.0` (可选)
- **文件**：`web/` 目录 (新增)
- **技术栈选择**：
  - 方案 A：React + TypeScript + TailwindCSS
  - 方案 B：原生 TypeScript + 轻量框架 (Alpine.js)
  - 推荐：方案 A 用于复杂交互，方案 B 用于轻量快速

#### 3.4 页面浏览界面
- **任务**：实现页面查看和导航
- **文件**：`web/src/components/PageViewer.tsx` (新增)
- **功能**：
  - Markdown 渲染（使用 marked 或 remark）
  - 代码高亮（highlight.js 或 prism）
  - 目录导航（TOC）
  - 面包屑导航

#### 3.5 页面编辑器
- **任务**：实现页面编辑功能
- **依赖**：`@monaco-editor/react: ^4.6.0` 或 `codemirror: ^6.0.0`
- **文件**：`web/src/components/PageEditor.tsx` (新增)
- **功能**：
  - Markdown 编辑器
  - 实时预览（双栏模式）
  - 自动保存草稿
  - 编辑冲突检测

#### 3.6 搜索界面
- **任务**：实现搜索页面
- **文件**：`web/src/components/SearchPage.tsx` (新增)
- **功能**：
  - 搜索框（带自动补全）
  - 搜索结果列表
  - 筛选器面板
  - 结果高亮

#### 3.7 管理界面
- **任务**：实现分类、标签管理
- **文件**：`web/src/components/AdminPanel.tsx` (新增)
- **功能**：
  - 分类管理
  - 标签管理
  - 页面列表管理
  - 系统设置

#### 3.8 测试覆盖
- **文件**：`tests/web/*.test.ts` (新增)
- **测试用例**：
  - API 接口测试
  - 前端组件测试（如使用 React）
  - 端到端测试（Playwright/Cypress）

---

### Phase 4: 富媒体与图表支持（内容丰富度）
**优先级：🟡 中 | 预估时间：6-8 小时**

#### 4.1 图片上传与管理
- **任务**：实现附件上传
- **文件**：`src/wiki/wiki-attachment.ts` (新增)
- **功能**：
  - 图片上传 API
  - 附件存储管理
  - 图片压缩和缩略图生成
  - 附件与页面关联

#### 4.2 图表渲染支持
- **任务**：支持 Mermaid 和 PlantUML
- **依赖**：`mermaid: ^10.6.0`
- **文件**：`web/src/utils/diagram-renderer.ts` (新增)
- **功能**：
  - Mermaid 图表渲染（流程图、时序图、类图等）
  - PlantUML 支持（可选）
  - 图表导出为图片

#### 4.3 文件附件管理
- **任务**：支持多种文件类型
- **文件**：`src/wiki/wiki-attachment.ts` (扩展)
- **功能**：
  - PDF、代码文件等附件上传
  - 附件预览
  - 附件版本管理

#### 4.4 测试覆盖
- **文件**：`tests/wiki/wiki-attachment.test.ts` (新增)
- **测试用例**：
  - 文件上传/下载
  - 图片处理
  - 图表渲染

---

### Phase 5: 协作功能（团队使用）
**优先级：🟡 中 | 预估时间：10-12 小时**

#### 5.1 评论系统
- **任务**：实现页面评论
- **文件**：`src/wiki/wiki-comment.ts` (新增)
- **功能**：
  - 页面评论 CRUD
  - 评论回复（嵌套）
  - 评论通知
  - Markdown 支持

#### 5.2 页面收藏与关注
- **任务**：实现个人收藏
- **文件**：`src/wiki/wiki-favorite.ts` (新增)
- **功能**：
  - 收藏页面
  - 关注页面变更
  - 个人收藏列表

#### 5.3 最近浏览历史
- **任务**：记录浏览历史
- **文件**：`src/wiki/wiki-history.ts` (扩展)
- **功能**：
  - 浏览记录存储
  - 最近浏览列表
  - 浏览统计

#### 5.4 通知系统（基础）
- **任务**：实现变更通知
- **文件**：`src/wiki/wiki-notification.ts` (新增)
- **功能**：
  - 页面变更通知
  - 评论回复通知
  - 通知中心
  - 邮件通知（可选）

#### 5.5 测试覆盖
- **文件**：`tests/wiki/wiki-comment.test.ts`, `tests/wiki/wiki-notification.test.ts` (新增)
- **测试用例**：
  - 评论功能
  - 收藏功能
  - 通知推送

---

### Phase 6: 性能优化与缓存（大规模使用）
**优先级：🟡 中 | 预估时间：6-8 小时**

#### 6.1 数据缓存层
- **任务**：实现多级缓存
- **文件**：`src/wiki/wiki-cache.ts` (新增)
- **功能**：
  - 内存缓存（热点数据）
  - 文件缓存（索引数据）
  - 缓存失效策略

#### 6.2 分页与懒加载
- **任务**：优化大数据量处理
- **文件**：`src/wiki/wiki-storage.ts` (修改)
- **功能**：
  - 页面列表分页
  - 搜索结果分页
  - 图片懒加载

#### 6.3 索引增量更新
- **任务**：优化搜索索引更新
- **文件**：`src/wiki/wiki-search-engine.ts` (修改)
- **功能**：
  - 增量索引更新
  - 批量索引优化
  - 索引压缩

#### 6.4 测试覆盖
- **文件**：`tests/wiki/wiki-cache.test.ts`, `tests/wiki/wiki-performance.test.ts` (新增)
- **测试用例**：
  - 缓存命中率
  - 分页功能
  - 性能基准测试

---

### Phase 7: 导入功能与集成（锦上添花）
**优先级：🟢 低 | 预估时间：4-6 小时**

#### 7.1 Markdown 批量导入
- **任务**：支持导入现有 Markdown
- **文件**：`src/wiki/wiki-importer.ts` (新增)
- **功能**：
  - 批量导入 Markdown 文件
  - 自动提取元数据（Frontmatter）
  - 链接转换

#### 7.2 Confluence 导入（可选）
- **任务**：支持 Confluence 导出格式
- **文件**：`src/wiki/wiki-importer.ts` (扩展)
- **功能**：
  - 解析 Confluence XML
  - 内容格式转换
  - 附件导入

#### 7.3 测试覆盖
- **文件**：`tests/wiki/wiki-importer.test.ts` (新增)
- **测试用例**：
  - Markdown 导入
  - 元数据提取

---

## 📦 依赖清单

### 新增依赖

```json
{
  "dependencies": {
    "flexsearch": "^0.7.31",
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "mermaid": "^10.6.0",
    "marked": "^11.0.0",
    "dompurify": "^3.0.6",
    "highlight.js": "^11.9.0",
    "multer": "^1.4.5-lts.1",
    "sharp": "^0.33.0",
    "uuid": "^9.0.0"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/cors": "^2.8.17",
    "@types/multer": "^1.4.11",
    "@types/uuid": "^9.0.7",
    "@types/dompurify": "^3.0.5",
    "vite": "^5.0.0",
    "react": "^18.2.0",
    "@types/react": "^18.2.0",
    "tailwindcss": "^3.3.0"
  }
}
```

---

## 📊 工作量汇总

| 阶段 | 任务数 | 预估时间 | 优先级 |
|-----|-------|---------|-------|
| Phase 1: 版本控制 | 5 | 6-8h | 🔴 高 |
| Phase 2: 搜索增强 | 6 | 8-10h | 🔴 高 |
| Phase 3: Web 界面 | 8 | 15-20h | 🔴 高 |
| Phase 4: 富媒体 | 4 | 6-8h | 🟡 中 |
| Phase 5: 协作功能 | 5 | 10-12h | 🟡 中 |
| Phase 6: 性能优化 | 4 | 6-8h | 🟡 中 |
| Phase 7: 导入功能 | 3 | 4-6h | 🟢 低 |
| **总计** | **35** | **55-72h** | - |

---

## 🚀 推荐实施顺序

### 第一阶段（核心功能，2-3 周）
1. **Phase 1: 版本控制** - 数据安全基础
2. **Phase 2: 搜索增强** - 核心体验提升

### 第二阶段（用户体验，3-4 周）
3. **Phase 3: Web 界面** - 最重要的用户体验改进
4. **Phase 4: 富媒体** - 内容丰富度

### 第三阶段（高级功能，2-3 周）
5. **Phase 5: 协作功能** - 团队使用必备
6. **Phase 6: 性能优化** - 大规模使用支持

### 第四阶段（扩展功能，1 周）
7. **Phase 7: 导入功能** - 锦上添花

---

## ✅ 完成标准

每个阶段完成后需要满足：
1. 所有功能代码实现完毕
2. 测试覆盖率 ≥ 80%
3. 通过 ESLint 代码检查
4. 更新相关文档
5. 提交 Git 仓库

---

请确认此计划后，我将开始按阶段实施。