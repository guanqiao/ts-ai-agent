# 架构优化 TDD 开发计划

## Phase 1: 基础架构重构 (P0)

### 1.1 引入依赖注入机制
**测试用例**:
- `di-container.test.ts`: 测试服务注册、解析、生命周期
- `service-locator.test.ts`: 测试服务定位器模式

**实现步骤**:
1. 创建轻量级 DI 容器 (`src/core/di/`)
2. 定义服务标识符和注册机制
3. 重构现有服务使用 DI

### 1.2 拆分 WikiManager
**测试用例**:
- `wiki-manager-refactored.test.ts`: 测试精简后的 WikiManager
- `wiki-service-factory.test.ts`: 测试服务工厂

**实现步骤**:
1. 创建 `WikiServiceFactory` 工厂类
2. 提取版本控制功能到 `VersioningManager`
3. 提取搜索功能到 `SearchManager`
4. WikiManager 保留为 Facade 入口

### 1.3 定义清晰的模块接口
**测试用例**:
- 各接口的 mock 实现测试
- 接口契约测试

**实现步骤**:
1. 创建 `src/core/interfaces/` 目录
2. 定义核心接口 (`IWikiManager`, `ILLMProvider`, `IAgent` 等)
3. 确保现有实现符合接口

---

## Phase 2: 核心能力增强 (P1)

### 2.1 LLM Provider 抽象层
**测试用例**:
- `llm-provider.test.ts`: 测试 Provider 抽象
- `openai-provider.test.ts`: OpenAI 实现
- `anthropic-provider.test.ts`: Anthropic 实现

**实现步骤**:
1. 定义 `ILLMProvider` 接口
2. 重构 `LLMService` 为 Provider 模式
3. 实现 OpenAI/Anthropic Provider

### 2.2 真实 Embedding 实现
**测试用例**:
- `embedding-service.test.ts`: 测试 embedding 生成
- `vector-similarity.test.ts`: 测试向量相似度计算

**实现步骤**:
1. 创建 `EmbeddingService` 接口
2. 使用 OpenAI Embeddings API
3. 重构 `WikiVectorStore` 使用真实 embedding

### 2.3 Agent 规划能力增强
**测试用例**:
- `tool-planner.test.ts`: 测试工具规划
- `agent-collaboration.test.ts`: 测试 Agent 协作

**实现步骤**:
1. 创建 `ToolPlanner` 类
2. 实现 LLM 驱动的工具选择
3. 添加 Agent 间通信机制

---

## Phase 3: 代码质量提升 (P2-P3)

### 3.1 类型系统整理
**测试用例**:
- 类型导入测试
- 类型兼容性测试

### 3.2 统一错误处理
**测试用例**:
- `result-pattern.test.ts`: 测试 Result 模式
- `error-handling.test.ts`: 测试错误传播

### 3.3 CLI 模块化
**测试用例**:
- 各命令模块的独立测试
- CLI 集成测试

### 3.4 模块边界重构
**测试用例**:
- 模块依赖测试
- 循环依赖检测测试

---

## 预计工作量
- Phase 1: ~15 个测试文件, ~20 个实现文件
- Phase 2: ~10 个测试文件, ~15 个实现文件
- Phase 3: ~8 个测试文件, ~10 个实现文件

## 执行顺序
按 Phase 1 → Phase 2 → Phase 3 顺序执行，每个任务遵循 TDD 红绿重构循环。