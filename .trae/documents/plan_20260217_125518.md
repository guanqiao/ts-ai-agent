# 架构深度优化计划

## 🔴 P0: 关键问题修复

### 1. 统一 LLM 服务层
**问题**: 存在两套 LLM 实现
- `src/llm/base.ts` 的 `LLMService` 使用假 embedding
- `src/llm/providers/index.ts` 有真实实现但未被使用

**优化方案**:
- 重构 `LLMService` 使用 `ILLMProvider` 接口
- 删除假 embedding 实现，统一使用 Provider
- 添加 Provider 工厂方法到 `LLMService`

### 2. 统一错误处理系统
**问题**: 两套错误系统并存
- `src/error/handler.ts` → `TSDGeneratorError`
- `src/core/types/index.ts` → `AppError`

**优化方案**:
- 统一使用 `AppError` 和 `Result` 模式
- 将 `ErrorHandler` 重构为使用 `Result` 模式
- 添加错误码映射

---

## 🟡 P1: 架构改进

### 3. WikiVectorStore 使用真实 Embedding
**问题**: `generateRandomEmbedding()` 使用随机数，语义搜索无意义

**优化方案**:
- 使用 `OpenAIProvider.embed()` 替代随机生成
- 添加 embedding 缓存机制
- 支持批量 embedding 生成

### 4. Agent 系统增强
**问题**: `AgentOrchestrator` 只是简单线性流程，未利用 `ToolPlanner`

**优化方案**:
- 集成 `ToolPlanner` 到 Agent 执行流程
- 添加 Agent 协作机制
- 支持并行 Agent 执行

### 5. 缓存系统集成
**问题**: `LLMCache` 未被 `LLMService` 使用

**优化方案**:
- 在 `LLMService` 中集成缓存
- 添加缓存命中统计
- 支持缓存预热

---

## 🟢 P2: 代码质量

### 6. 模块导出完善
**问题**: 新增 `core/` 模块未在 `index.ts` 导出

**优化方案**:
- 更新 `src/index.ts` 导出 DI、Result、接口等
- 添加使用示例到 README

### 7. 搜索系统统一
**问题**: `HybridSearch` 和 `WikiVectorStore` 功能重叠

**优化方案**:
- 统一搜索接口 `ISearchEngine`
- `WikiVectorStore` 作为 `HybridSearch` 的语义搜索后端

### 8. 配置管理增强
**问题**: `ConfigManager` 未使用 DI

**优化方案**:
- 注册 `ConfigManager` 到 DI 容器
- 添加配置热重载
- 支持环境变量覆盖

---

## 📊 预计工作量

| 优先级 | 任务 | 测试文件 | 实现文件 |
|--------|------|----------|----------|
| P0 | LLM 服务统一 | 1 | 2 |
| P0 | 错误处理统一 | 1 | 2 |
| P1 | Embedding 真实化 | 1 | 1 |
| P1 | Agent 系统增强 | 2 | 2 |
| P1 | 缓存集成 | 1 | 1 |
| P2 | 模块导出 | 0 | 1 |
| P2 | 搜索统一 | 1 | 2 |
| P2 | 配置增强 | 1 | 1 |

**总计**: 8 个测试文件, 12 个实现文件修改